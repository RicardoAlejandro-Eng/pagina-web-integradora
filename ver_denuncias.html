<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Mis Denuncias</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body class="bg-light">
  <nav class="navbar navbar-light bg-white shadow-sm">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="menu.html">
        <img src="img/logo.svg" style="height:36px;object-fit:contain" alt="logo">
        <span class="ms-2 text-primary fw-bold">Mis Denuncias</span>
      </a>
      <div>
        <a href="hacer_denuncia.html" class="btn btn-primary">Nueva denuncia</a>
      </div>
    </div>
  </nav>

  <div class="container py-4" style="max-width:900px">
    <div class="card p-3 mb-3">
      <div class="d-flex gap-2 flex-wrap">
        <button class="btn btn-warning" onclick="filterClick('Pendiente')">Pendiente</button>
        <button class="btn btn-success" onclick="filterClick('Aprobada')">Aprobada</button>
        <button class="btn btn-danger" onclick="filterClick('Rechazada')">Rechazada</button>
        <button class="btn btn-outline-secondary" onclick="filterClick('Todas')">Mostrar todas</button>
      </div>
    </div>

    <div id="listaDenuncias"></div>

    <div class="text-center mt-4">
      <div class="card p-3 footer-note">
        <div style="width:100px;height:6px;background:#bdbdbd;margin:0 auto 8px;border-radius:3px"></div>
        <p class="mb-1 text-muted fst-italic">No hay más denuncias que mostrar</p>
        <p class="mb-0 text-muted">Gracias por contribuir a mejorar tu comunidad</p>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  async function cargarDenuncias(status = "Todas") {
    try {
      const user_id = localStorage.getItem('user_id');
      const token = localStorage.getItem('token');
      if(!user_id || !token){
        alert('No cuenta con las credenciales necesarias');
        return;
      }

      const body = { user_id };
      if (status !== "Todas") {
        const mapStatus = {
          Pendiente: "pending",
          Aprobada: "created",
          Rechazada: "rejected"
        };
        body.status = mapStatus[status];
      }

      const response = await fetch('http://localhost:3000/api/report/get-reports', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      if (!response.ok) throw new Error(`Error al obtener denuncias`);
      const data = await response.json();
      mostrarDenuncias(data);
    } catch (error) {
      console.error(error);
      alert("Hubo un error al cargar las denuncias");
    }
  }

  // Mostrar denuncias con botones Editar y Eliminar
  function mostrarDenuncias(denuncias = []) {
    
    const lista = document.getElementById("listaDenuncias");
    lista.innerHTML = "";

    if (!denuncias || denuncias.length === 0) {
      lista.innerHTML = `<div class="alert alert-secondary text-center mt-3">
        No se encontraron denuncias para este filtro.
      </div>`;
      return;
    }

    denuncias.forEach((d) => {
      const card = document.createElement("div");
      card.className = "card mb-3 shadow-sm";
      card.innerHTML = `
        <div class="card-body">
          <h5 class="card-title text-primary">${d.title || "Sin título"}</h5>
          <p class="card-text mb-1"><strong>Categoría:</strong> ${d.category || "N/A"}</p>
          <p class="card-text mb-1"><strong>Descripción:</strong> ${d.description || "Sin descripción"}</p>
          <p class="card-text mb-1"><strong>Ubicación:</strong> ${d.location || "No especificada"}</p>
          <span class="badge ${
            d.status === "pending" ? "bg-warning text-dark" :
            d.status === "created" ? "bg-success" : "bg-danger"
          }">${d.status.toUpperCase()}</span>

          <div class="mt-3 d-flex gap-2">
            <a href="detalle_denuncia.html?id=${d.id}" class="btn btn-outline-primary btn-sm">Ver detalle</a>
            <button class="btn btn-warning btn-sm text-dark" onclick="editarDenuncia('${d.id}')">Editar</button>
            <button class="btn btn-danger btn-sm" onclick="eliminarDenuncia('${d.id}')">Eliminar</button>
          </div>
        </div>
      `;
      lista.appendChild(card);
    });
  }

  async function editarDenuncia(id) {
    const nuevoTitulo = prompt("Nuevo título de la denuncia:");
    if (!nuevoTitulo) return;

    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`http://localhost:3000/api/report/update-report/${id}`, {
        method: "PATCH",
        headers: { 
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          user_id: "",
          category: "",
          title: nuevoTitulo,
          descripcion: "",
          location: ""
        })
      });

      console.log("holi", response);


      if (!response.ok) throw new Error("Error al editar la denuncia");
      alert("Denuncia actualizada correctamente");
      cargarDenuncias(); // recargar lista
    } catch (error) {
      console.error(error);
      alert("No se pudo editar la denuncia");
    }
  }

  async function eliminarDenuncia(id) {
    const confirmar = confirm("¿Estás seguro de eliminar esta denuncia?");
    if (!confirmar) return;

    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`http://localhost:3000/api/report/delete-report/${id}`, {
        method: "DELETE",
        headers: { "Authorization": `Bearer ${token}` }
      });

      if (!response.ok) throw new Error("Error al eliminar la denuncia");
      alert("Denuncia eliminada correctamente");
      cargarDenuncias(); // recargar lista
    } catch (error) {
      console.error(error);
      alert("No se pudo eliminar la denuncia");
    }
  }

  function filterClick(status) {
    cargarDenuncias(status);
  }

  document.addEventListener("DOMContentLoaded", () => {
    cargarDenuncias("Todas");
  });
</script>
</body>
</html>
